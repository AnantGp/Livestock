# Pipeline Configuration
pipeline:
  # Model paths
  yolo_model: models/yolo/exp/weights/best.pt
  unet_model: models/unet/best.pth
  
  # CSV metadata
  metadata_csv: dataset.csv
  
  # Inference settings
  yolo_conf: 0.25
  yolo_iou: 0.45
  unet_threshold: 0.75

  # Which YOLO detection to segment when multiple boxes exist
  # (helps avoid a near-full-frame box dominating the crop)
  best_box:
    min_area_frac: 0.01
    max_area_frac: 0.85
  
  # Image settings
  img_size: 640
  unet_img_size: 256

  # Optional refinement to reduce grass/background spill inside the YOLO crop
  # Uses GrabCut initialized from U-Net probabilities.
  grabcut_refine:
    enabled: true
    prob_low: 0.35
    prob_high: 0.80
    iterations: 5
    border: 15
    max_dim: 900
    fallback_threshold: 0.75

  # Segmentation mask cleanup (reduces green spill on background)
  mask_postprocess:
    enabled: true
    opening_kernel: 9
    opening_iterations: 3
    erode_kernel: 17
    erode_iterations: 4
    restore_dilate: true
    keep_largest_component: true
  
  # LLM settings
  llm:
    enabled: true
    model: Qwen/Qwen2.5-VL-7B-Instruct
    device: auto  # auto, cpu, cuda

    # Prevent CUDA OOM when running a large VLM alongside YOLO/U-Net.
    # On ~15GB GPUs, fp16 Qwen2.5-VL-7B commonly OOM; 4-bit is recommended.
    release_vision_models_before_llm: true
    load_in_4bit: true
    load_in_8bit: false
    bnb_4bit_quant_type: nf4
    bnb_4bit_use_double_quant: true
    bnb_4bit_compute_dtype: float16

    # Generation defaults (lower values reduce KV-cache memory).
    max_new_tokens: 512
    temperature: 0.7
    do_sample: true
    use_cache: true
    
    # OOM fallback settings
    oom_fallback: true
    oom_fallback_max_new_tokens: 256

output:
  save_visualizations: true
  save_masks: true
  save_reports: true
  output_dir: outputs
